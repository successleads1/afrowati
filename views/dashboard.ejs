<% include('partials/header') %>

<style>
  /* Make the QR large & crisp */
  .qr-img {
    width: 320px;
    max-width: 100%;
    height: auto;
    image-rendering: pixelated;
    cursor: pointer;
  }

  /* Lightbox overlay */
  .lightbox {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1050;
  }
  .lightbox img {
    max-width: 90%;
    max-height: 90%;
  }
</style>

<div class="container py-5">
  <!-- Welcome -->
  <div class="row justify-content-center mb-4">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-sm text-center">
        <div class="card-body">
          <h2 class="card-title">Welcome, <%= user.name %>!</h2>
          <p class="card-text">
            Configure your bot or scan your WhatsApp QR below.
          </p>
          <a href="/setup" class="btn btn-wa">Configure Your Bot</a>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Card -->
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card border-success shadow-sm">
        <div class="card-header bg-wa text-white">
          <h5 class="mb-0">WhatsApp QR Code</h5>
        </div>
        <div class="card-body text-center">
          <% if (qr) { %>
            <!-- tappable QR -->
            <a href="#" id="show-lightbox">
              <img
                src="data:image/png;base64,<%= qr %>"
                class="qr-img mb-3"
                alt="WhatsApp QR Code"
              />
            </a>
            <p class="text-muted">
              Tap the QR to view full‑size, then scan with WhatsApp.
            </p>
            <p class="small text-muted">
              If you opened this on mobile, download and use WhatsApp’s 
              “Link devices → Scan from gallery” feature.
            </p>
            <a
              href="data:image/png;base64,<%= qr %>"
              download="whatsapp-qr.png"
              class="btn btn-wa mb-2"
            >
              Download QR
            </a>
            <br/>
            <button
              type="button"
              onclick="location.reload()"
              class="btn btn-outline-wa"
            >
              Regenerate QR
            </button>
          <% } else { %>
            <div
              class="spinner-border text-success mb-3"
              style="width:3rem;height:3rem;"
              role="status"
            ></div>
            <p class="text-muted">
              QR not ready yet. Please configure your bot and refresh.
            </p>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox">
  <img id="lightbox-img" src="" alt="Full‑size QR"/>
</div>

<script>
  // open lightbox
  document
    .getElementById('show-lightbox')
    ?.addEventListener('click', e => {
      e.preventDefault();
      const src = document.querySelector('.qr-img').src;
      document.getElementById('lightbox-img').src = src;
      document.getElementById('lightbox').style.display = 'flex';
    });

  // close lightbox on click
  document
    .getElementById('lightbox')
    .addEventListener('click', () => {
      document.getElementById('lightbox').style.display = 'none';
    });
</script>

<% include('partials/footer') %>
